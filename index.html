<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        #messages {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #message-input, #peer-id-input {
            width: calc(100% - 90px);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #send-button, #connect-button {
            padding: 8px 16px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="chat-container" class="bg-white shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-center">P2P Chat Platform</h1>
        <p class="text-gray-500 italic mb-4 text-center">Share your Peer ID with another user to chat in real-time. Messages are stored locally.</p>
        <div class="mb-4">
            <label class="block text-gray-700">Your Peer ID: <span id="my-peer-id" class="font-mono"></span></label>
            <input id="peer-id-input" type="text" placeholder="Enter friend's Peer ID..." class="mr-2 mt-2">
            <button id="connect-button" class="bg-green-500 text-white hover:bg-green-600">Connect</button>
        </div>
        <div id="messages" class="mb-4"></div>
        <div class="flex">
            <input id="message-input" type="text" placeholder="Type your message..." class="mr-2">
            <button id="send-button" class="bg-blue-500 text-white hover:bg-blue-600">Send</button>
        </div>
    </div>

    <script>
        // Generate a short, memorable Peer ID
        function generateShortPeerId(username) {
            const randomString = Math.random().toString(36).substring(2, 6); // 4-character random string
            return `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}-${randomString}`;
        }

        // Get DOM elements
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const peerIdInput = document.getElementById('peer-id-input');
        const connectButton = document.getElementById('connect-button');
        const myPeerId = document.getElementById('my-peer-id');
        const messages = document.getElementById('messages');

        // Get or prompt for username
        let username = localStorage.getItem('chatUsername') || prompt('Enter your username') || 'Anonymous';
        localStorage.setItem('chatUsername', username);

        // Initialize PeerJS with short Peer ID
        const shortPeerId = generateShortPeerId(username);
        const peer = new Peer(shortPeerId);
        let conn = null;

        // Load messages from localStorage
        let chatMessages = JSON.parse(localStorage.getItem('chatMessages')) || [
            { username: 'System', message: 'Welcome to the chat! Share your Peer ID to connect with others.', timestamp: Date.now() }
        ];

        // Display messages
        function displayMessage(data) {
            const messageElement = document.createElement('div');
            messageElement.className = 'p-2 border-b';
            messageElement.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
            chatMessages.push(data);
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        }

        // Display initial messages
        chatMessages.forEach(displayMessage);

        // Handle PeerJS connection
        peer.on('open', (id) => {
            myPeerId.textContent = id;
        });

        peer.on('connection', (connection) => {
            conn = connection;
            conn.on('data', (data) => {
                displayMessage(data);
            });
            displayMessage({ username: 'System', message: `Connected to peer ${conn.peer}`, timestamp: Date.now() });
        });

        connectButton.addEventListener('click', () => {
            const peerId = peerIdInput.value.trim();
            if (peerId) {
                conn = peer.connect(peerId);
                conn.on('open', () => {
                    displayMessage({ username: 'System', message: `Connected to peer ${peerId}`, timestamp: Date.now() });
                });
                conn.on('data', (data) => {
                    displayMessage(data);
                });
                peerIdInput.value = '';
            }
        });

        // Send message
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                const data = { username, message, timestamp: Date.now() };
                displayMessage(data);
                if (conn && conn.open) {
                    conn.send(data);
                }
                messageInput.value = '';
            }
        });

        // Send message on Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        peerIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectButton.click();
            }
        });
    </script>
</body>
</html>